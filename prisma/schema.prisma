generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =====================================================
// PAIEMENTS / Payouts Formateurs
// =====================================================

model TrainerBanking {
  id            String  @id @default(cuid())
  trainerId     String  @unique
  email         String?
  payoutName    String?
  payoutCountry String?
  payoutIban    String?
  payoutBic     String?
  autoPayout    Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  summary PayoutsSummary?
  history PayoutsHistory[]
}

model PayoutsSummary {
  id        String @id @default(cuid())
  trainerId String @unique

  availableAmount Decimal @default(0.0)
  pendingAmount   Decimal @default(0.0)
  currency        String  @default("EUR")

  updatedAt DateTime @updatedAt

  trainer TrainerBanking @relation(fields: [trainerId], references: [trainerId])
}

model PayoutsHistory {
  id        String @id @default(cuid())
  trainerId String

  type     PayoutType
  status   PayoutStatus
  amount   Decimal
  currency String       @default("EUR")

  date DateTime @default(now())
  meta Json?

  trainer TrainerBanking @relation(fields: [trainerId], references: [trainerId])

  @@index([trainerId, date])
}

enum PayoutType {
  sale
  withdraw
  paid
}

enum PayoutStatus {
  available
  requested
  paid
  reversed
}

// =====================================================
// FORMATIONS
// =====================================================

model Course {
  id String @id @default(cuid())

  // Shopify
  shopifyProductId     String  @unique
  shopifyProductHandle String?
  shopifyProductTitle  String?

  // Affichage / contenu
  title     String
  subtitle  String?
  imageUrl  String?
  pdfUrl    String?
  accessUrl String

  // Métadonnées pédagogiques
  categoryLabel  String?
  levelLabel     String?
  estimatedHours Float?

  // Formateur
  trainerEmail     String?
  trainerShopifyId String?

  // Prix (nullable pour migration safe)
  priceCents Int?

  // Relations
  enrollments StudentCourse[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([shopifyProductId])
  @@index([accessUrl])
  @@index([trainerEmail])
}

// =====================================================
// INSCRIPTIONS / Étudiants
// =====================================================

model StudentCourse {
  id String @id @default(cuid())

  // Élève
  studentEmail      String
  shopifyCustomerId String?

  // Formation
  courseId String
  course   Course @relation(fields: [courseId], references: [id])

  // Commande / paiement
  shopifyOrderId    String?
  shopifyLineItemId String?

  // Suivi
  purchaseDate DateTime     @default(now())
  lastAccessAt DateTime?
  status       CourseStatus @default(IN_PROGRESS)
  archived     Boolean      @default(false)

  // Progression
  progressPct  Int       @default(0)
  lastLessonId String?
  completedAt  DateTime?
  progressData Json?

  @@index([studentEmail])
  @@index([shopifyCustomerId])
  @@index([shopifyOrderId])
  @@index([courseId])
  @@index([studentEmail, courseId])
}

enum CourseStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
}
