// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// -----------------------------------------------------
// PAIEMENTS FORMATEURS
// -----------------------------------------------------

model TrainerBanking {
  id            String   @id @default(cuid())
  trainerId     String   @unique
  email         String?
  payoutName    String?
  payoutCountry String?
  payoutIban    String?
  payoutBic     String?
  autoPayout    Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  summary PayoutsSummary?
  history PayoutsHistory[]
}

model PayoutsSummary {
  id              String   @id @default(cuid())
  trainerId       String   @unique
  availableAmount Decimal  @default(0.0)
  pendingAmount   Decimal  @default(0.0)
  currency        String   @default("EUR")
  updatedAt       DateTime @updatedAt

  trainer TrainerBanking @relation(fields: [trainerId], references: [trainerId])
}

model PayoutsHistory {
  id        String       @id @default(cuid())
  trainerId String
  type      PayoutType
  status    PayoutStatus
  amount    Decimal
  currency  String       @default("EUR")
  date      DateTime     @default(now())
  meta      Json?

  trainer TrainerBanking @relation(fields: [trainerId], references: [trainerId])

  @@index([trainerId, date])
}

enum PayoutType {
  sale
  withdraw
  paid
}

enum PayoutStatus {
  available
  requested
  paid
  reversed
}

// -----------------------------------------------------
// FORMATIONS (plateforme)
// -----------------------------------------------------

model Course {
  id String @id @default(cuid())

  // Lien vers le produit Shopify
  shopifyProductId     String  @unique
  shopifyProductHandle String?
  shopifyProductTitle  String?

  // Contenu / affichage
  title     String
  subtitle  String?
  imageUrl  String?
  pdfUrl    String?
  accessUrl String // ex: "/pages/formation-demo-ia"

  // Métadonnées pédagogiques
  categoryLabel  String?
  levelLabel     String?
  estimatedHours Float?

  // Formateur
  trainerEmail     String?
  trainerShopifyId String?

  // Relations
  enrollments StudentCourse[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([shopifyProductId])
  @@index([accessUrl])
  @@index([trainerEmail])
}

model StudentCourse {
  id String @id @default(cuid())

  // Élève
  studentEmail      String
  shopifyCustomerId String?

  // Formation
  courseId String
  course   Course @relation(fields: [courseId], references: [id])

  // Commande Shopify (ou Stripe session id si checkout Stripe)
  shopifyOrderId    String?
  shopifyLineItemId String?

  // Suivi
  purchaseDate DateTime     @default(now())
  lastAccessAt DateTime?
  status       CourseStatus @default(IN_PROGRESS)
  archived     Boolean      @default(false)

  // ✅ Progression réelle (UX)
  // 0..100
  progressPct  Int   @default(0)
  // (vidéo) dernière leçon/chapitre vu(e) — simple et efficace
  lastLessonId String?
  // date de complétion (quand progress=100 ou status=COMPLETED)
  completedAt  DateTime?
  // JSON libre (pages lues, timestamps, etc.)
  progressData Json?

  @@index([studentEmail])
  @@index([shopifyCustomerId])
  @@index([shopifyOrderId])
  @@index([courseId])
  @@index([studentEmail, courseId])
}

enum CourseStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
}
